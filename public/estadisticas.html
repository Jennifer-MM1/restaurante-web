<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - RestauranteWeb</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
            text-decoration: none;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
        }

        .btn-outline:hover {
            background-color: var(--gray-50);
            border-color: var(--gray-400);
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--gray-600);
            font-size: 1.1rem;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-600);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.25rem;
        }

        .stat-icon.primary { background-color: var(--primary); }
        .stat-icon.success { background-color: var(--success); }
        .stat-icon.warning { background-color: var(--warning); }
        .stat-icon.error { background-color: var(--error); }
        .stat-icon.info { background-color: var(--info); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--error); }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--white);
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .chart-container.small {
            height: 300px;
        }

        /* Restaurant Info Card */
        .restaurant-info {
            background: var(--white);
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .restaurant-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .restaurant-avatar {
            width: 60px;
            height: 60px;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 1.5rem;
        }

        .restaurant-details h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .restaurant-type {
            color: var(--gray-500);
            text-transform: capitalize;
            font-size: 0.9rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
        }

        .info-icon {
            width: 32px;
            height: 32px;
            border-radius: 0.5rem;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .info-content {
            flex: 1;
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .info-value {
            font-weight: 500;
            color: var(--gray-900);
            font-size: 0.9rem;
        }

        /* Data Table */
        .data-section {
            background: var(--white);
            border-radius: 0.75rem;
            border: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .data-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .data-content {
            padding: 1.5rem;
        }

        .menu-categories {
            display: grid;
            gap: 1rem;
        }

        .category-item {
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary);
        }

        .category-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .category-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .category-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-left: 4px solid var(--primary);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 12px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success { border-left-color: var(--success); }
        .notification.error { border-left-color: var(--error); }
        .notification.warning { border-left-color: var(--warning); }
        
        .notification i {
            font-size: 18px;
            color: var(--primary);
        }
        
        .notification.success i { color: var(--success); }
        .notification.error i { color: var(--error); }
        .notification.warning i { color: var(--warning); }
        
        .notification-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: var(--gray-400);
        }
        
        .notification-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav {
                padding: 0 1rem;
            }
            
            .main {
                padding: 1rem;
            }
            
            .stats-overview {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
        }
        /* ===== CSS CORREGIDO PARA MEN√ö HAMBURGUESA ===== */

/* Bot√≥n hamburguesa con z-index alto */
.nav-toggle {
    display: none;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--gray-700);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
    min-width: 44px;
    min-height: 44px;
    z-index: 1002 !important; /* Asegurar que est√© por encima de todo */
    position: relative;
    user-select: none; /* Evitar selecci√≥n de texto */
}

.nav-toggle:hover {
    background-color: var(--gray-100);
    color: var(--primary);
}

.nav-toggle:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Icono del toggle - evitar interferencias */
.nav-toggle i {
    pointer-events: none !important; /* CR√çTICO: evitar conflictos con el icono */
    transition: transform 0.3s ease;
    display: block;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Animaci√≥n del icono */
.nav-toggle[aria-expanded="true"] i {
    transform: rotate(180deg);
}

/* Header con z-index apropiado */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--gray-200);
    z-index: 1001 !important;
    height: 70px;
    width: 100%;
}

/* Overlay con z-index menor que el bot√≥n */
.nav-overlay {
    position: fixed;
    top: 70px;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 999 !important; /* Menor que el bot√≥n toggle */
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
}

.nav-overlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
}

/* ===== PARA INDEX.HTML ===== */
@media (max-width: 768px) {
    .nav-toggle {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }
    
    .nav-menu {
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background-color: var(--white);
        border-top: 1px solid var(--gray-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        padding: var(--spacing-lg);
        gap: var(--spacing-lg);
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000 !important; /* Entre overlay y bot√≥n */
        max-height: calc(100vh - 70px);
        overflow-y: auto;
    }
    
    .nav-menu.active {
        transform: translateY(0) !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
}

/* ===== PARA MANAGE-RESTAURANT.HTML ===== */
@media (max-width: 768px) {
    .nav-links {
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background-color: var(--white);
        border-top: 1px solid var(--gray-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 1000 !important;
        max-height: calc(100vh - 70px);
        overflow-y: auto;
    }
    
    .nav-links.active {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }
}

/* ===== PARA ESTADISTICAS.HTML ===== */
@media (max-width: 768px) {
    .nav-actions {
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background-color: var(--white);
        border-top: 1px solid var(--gray-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 1000 !important;
        max-height: calc(100vh - 70px);
        overflow-y: auto;
    }
    
    .nav-actions.active {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
    }
}

/* Estilos generales para todos los men√∫s m√≥viles */
.nav-menu.active,
.nav-links.active,
.nav-actions.active {
    z-index: 1000 !important;
}

/* Asegurar que los enlaces/botones sean accesibles */
.nav-link,
.btn {
    position: relative;
    z-index: auto;
    user-select: none;
}

/* Evitar doble tap en m√≥vil */
@media (hover: none) and (pointer: coarse) {
    .nav-toggle {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    
    .nav-toggle:active {
        transform: scale(0.95);
    }
}

/* Debugging styles (usar solo para encontrar problemas) */
/*
.nav-toggle {
    border: 2px solid red !important;
}

.nav-overlay {
    border: 2px solid blue !important;
}

.nav-menu.active,
.nav-links.active,
.nav-actions.active {
    border: 2px solid green !important;
}
*/
    </style>
</head>
<body>
    <!-- Header -->
<!-- ===== HEADER MEJORADO CON NAVEGACI√ìN M√ìVIL ===== -->
<header class="header">
    <nav class="nav">
        <a href="/admin.html" class="logo">
            <i class="fas fa-utensils"></i>
            RestauranteWeb
        </a>
        
        <!-- Bot√≥n hamburguesa para m√≥vil -->
        <button class="nav-toggle" id="nav-toggle" aria-label="Abrir men√∫">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="nav-actions" id="nav-actions">
            <button class="btn btn-primary" onclick="refreshStats()">
                <i class="fas fa-sync-alt"></i>
                <span>Actualizar</span>
            </button>
            <a href="/admin.html" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                <span>Volver al Panel</span>
            </a>
        </div>
    </nav>
</header>

<!-- ===== JAVASCRIPT ADICIONAL PARA NAVEGACI√ìN M√ìVIL ===== -->
<script>
// Agregar al final de tu script existente, antes del DOMContentLoaded

function setupMobileNavigation() {
    const navToggle = document.getElementById('nav-toggle');
    const navActions = document.getElementById('nav-actions');
    
    if (!navToggle || !navActions) {
        console.warn('Elementos de navegaci√≥n m√≥vil no encontrados');
        return;
    }
    
    console.log('‚úÖ Navegaci√≥n m√≥vil inicializada');
    
    // Crear overlay
    let overlay = document.querySelector('.nav-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'nav-overlay';
        overlay.id = 'nav-overlay';
        document.body.appendChild(overlay);
    }
    
    let isMenuOpen = false;
    
    function openMenu() {
        isMenuOpen = true;
        navActions.classList.add('active');
        overlay.classList.add('active');
        updateIcon();
        document.body.style.overflow = 'hidden';
    }
    
    function closeMenu() {
        isMenuOpen = false;
        navActions.classList.remove('active');
        overlay.classList.remove('active');
        updateIcon();
        document.body.style.overflow = '';
    }
    
    function updateIcon() {
        const icon = navToggle.querySelector('i');
        if (icon) {
            if (isMenuOpen) {
                icon.className = 'fas fa-times';
                navToggle.setAttribute('aria-label', 'Cerrar men√∫');
            } else {
                icon.className = 'fas fa-bars';
                navToggle.setAttribute('aria-label', 'Abrir men√∫');
            }
        }
    }
    
    // Toggle del men√∫
    navToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (isMenuOpen) {
            closeMenu();
        } else {
            openMenu();
        }
    });
    
    // Cerrar men√∫ al hacer click en un bot√≥n
    navActions.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn') || e.target.closest('.btn')) {
            setTimeout(closeMenu, 100);
        }
    });
    
    // Cerrar men√∫ al hacer click en overlay
    overlay.addEventListener('click', function() {
        closeMenu();
    });
    
    // Cerrar men√∫ con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isMenuOpen) {
            closeMenu();
        }
    });
    
    // Cerrar men√∫ al redimensionar ventana
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768 && isMenuOpen) {
            closeMenu();
        }
    });
}

// Funci√≥n mejorada para refrescar estad√≠sticas (compatible con m√≥vil)
async function refreshStats() {
    showNotification('Actualizando estad√≠sticas...', 'info');
    
    // Cerrar men√∫ m√≥vil si est√° abierto
    const navActions = document.getElementById('nav-actions');
    if (navActions && navActions.classList.contains('active')) {
        navActions.classList.remove('active');
        document.querySelector('.nav-overlay')?.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Destruir gr√°ficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};

    await loadRestaurantStats();
    showNotification('Estad√≠sticas actualizadas correctamente', 'success');
}

// Funci√≥n para redimensionar gr√°ficos en responsive
function resizeCharts() {
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.resize === 'function') {
            chart.resize();
        }
    });
}

// Modificar tu DOMContentLoaded existente para incluir navegaci√≥n m√≥vil:
document.addEventListener('DOMContentLoaded', async function() {
    // Agregar navegaci√≥n m√≥vil
    setupMobileNavigation();
    
    // Tu c√≥digo existente...
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
        await loadRestaurantStats();
    }
    
    // Listener para redimensionar gr√°ficos
    window.addEventListener('resize', function() {
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(resizeCharts, 250);
    });
});

// Funci√≥n mejorada para crear gr√°ficos que sea responsive
function createPricesChart() {
    const ctx = document.getElementById('pricesChart');
    if (!ctx) return;

    const menu = currentRestaurant.menu || [];
    const categories = [];
    const avgPrices = [];
    const minPrices = [];
    const maxPrices = [];

    menu.forEach(category => {
        const items = category.items || [];
        const prices = items.map(item => item.precio).filter(price => typeof price === 'number');
        
        if (prices.length > 0) {
            categories.push(category.categoria);
            avgPrices.push(Math.round(prices.reduce((a, b) => a + b, 0) / prices.length));
            minPrices.push(Math.min(...prices));
            maxPrices.push(Math.max(...prices));
        }
    });

    if (charts.pricesChart) {
        charts.pricesChart.destroy();
    }

    charts.pricesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Precio Promedio',
                data: avgPrices,
                backgroundColor: 'rgba(37, 99, 235, 0.8)',
                borderColor: 'rgba(37, 99, 235, 1)',
                borderWidth: 1
            }, {
                label: 'Precio M√≠nimo',
                data: minPrices,
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1
            }, {
                label: 'Precio M√°ximo',
                data: maxPrices,
                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                borderColor: 'rgba(245, 158, 11, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: window.innerWidth < 768 ? 'bottom' : 'top',
                    labels: {
                        boxWidth: window.innerWidth < 768 ? 10 : 40,
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        },
                        maxRotation: window.innerWidth < 768 ? 45 : 0
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        },
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n mejorada para crear gr√°fico de categor√≠as
function createCategoryChart() {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;

    const menu = currentRestaurant.menu || [];
    const categories = [];
    const itemCounts = [];
    const colors = [
        '#2563eb', '#16a34a', '#dc2626', '#ca8a04', '#9333ea',
        '#c2410c', '#0891b2', '#be123c', '#4338ca', '#059669'
    ];

    menu.forEach((category, index) => {
        const itemCount = category.items ? category.items.length : 0;
        if (itemCount > 0) {
            categories.push(category.categoria);
            itemCounts.push(itemCount);
        }
    });

    if (charts.categoryChart) {
        charts.categoryChart.destroy();
    }

    charts.categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories,
            datasets: [{
                data: itemCounts,
                backgroundColor: colors.slice(0, categories.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: window.innerWidth < 768 ? 10 : 20,
                        usePointStyle: true,
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        }
                    }
                }
            }
        }
    });
}
</script>

    <!-- Main Content -->
    <main class="main">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Estad√≠sticas</h1>
            <p class="page-subtitle">An√°lisis y m√©tricas de tu establecimiento</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading">
            <div class="spinner"></div>
            <p>Cargando estad√≠sticas...</p>
        </div>

        <!-- Content (Hidden initially) -->
        <div id="content" style="display: none;">
            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Categor√≠as del Men√∫</div>
                        <div class="stat-icon primary">
                            <i class="fas fa-list"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="total-categories">0</div>
                    <div class="stat-change">
                        <i class="fas fa-info-circle"></i>
                        <span>Categor√≠as disponibles</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Productos en Men√∫</div>
                        <div class="stat-icon success">
                            <i class="fas fa-utensils"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="total-items">0</div>
                    <div class="stat-change">
                        <i class="fas fa-arrow-up"></i>
                        <span>Items totales</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Precio Promedio</div>
                        <div class="stat-icon warning">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="average-price">$0</div>
                    <div class="stat-change">
                        <i class="fas fa-calculator"></i>
                        <span>Por producto</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Completitud del Perfil</div>
                        <div class="stat-icon info">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="profile-completion">0%</div>
                    <div class="stat-change" id="completion-status">
                        <i class="fas fa-check"></i>
                        <span>Completado</span>
                    </div>
                </div>
            </div>

            <!-- Restaurant Info -->
            <div class="restaurant-info">
                <div class="restaurant-header">
                    <div class="restaurant-avatar" id="restaurant-avatar">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="restaurant-details">
                        <h3 id="restaurant-name">Mi Restaurante</h3>
                        <p class="restaurant-type" id="restaurant-type">restaurante</p>
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">Ciudad</div>
                            <div class="info-value" id="restaurant-city">-</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">Tel√©fono</div>
                            <div class="info-value" id="restaurant-phone">-</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">D√≠as Abierto</div>
                            <div class="info-value" id="days-open">0/7</div>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="info-content">
                            <div class="info-label">Activo desde</div>
                            <div class="info-value" id="restaurant-since">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Distribuci√≥n de Precios por Categor√≠a</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="pricesChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Productos por Categor√≠a</h3>
                    </div>
                    <div class="chart-container small">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Menu Categories Data -->
            <div class="data-section">
                <div class="data-header">
                    <h3 class="data-title">An√°lisis del Men√∫</h3>
                </div>
                <div class="data-content">
                    <div class="menu-categories" id="menu-analysis">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin + '/api';
        let currentRestaurant = null;
        let charts = {};

        // Funciones de notificaci√≥n
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <span class="notification-message">${message}</span>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            notification.querySelector('.notification-close').onclick = () => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            };
        }

        // Verificar autenticaci√≥n
        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                showNotification('No has iniciado sesi√≥n', 'error');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    return true;
                } else {
                    throw new Error('Token inv√°lido');
                }
            } catch (error) {
                console.error('Error verificando auth:', error);
                localStorage.removeItem('authToken');
                showNotification('Sesi√≥n expirada, redirigiendo...', 'warning');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
                return false;
            }
        }

        // Cargar estad√≠sticas del restaurante
        async function loadRestaurantStats() {
            const token = localStorage.getItem('authToken');
            
            try {
                const response = await fetch(`${API_BASE}/admin/my-restaurant`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentRestaurant = result.data;
                    updateStatsUI();
                    createCharts();
                } else if (response.status === 404) {
                    showNotification('No tienes un restaurante registrado a√∫n', 'warning');
                    setTimeout(() => {
                        window.location.href = '/admin.html';
                    }, 3000);
                } else {
                    throw new Error('Error al cargar estad√≠sticas');
                }
            } catch (error) {
                console.error('Error loading restaurant stats:', error);
                showNotification('Error al cargar estad√≠sticas del restaurante', 'error');
            } finally {
                // Ocultar loading
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
        }

        // Actualizar UI con estad√≠sticas
        function updateStatsUI() {
            if (!currentRestaurant) return;

            // Informaci√≥n b√°sica del restaurante
            const restaurantName = document.getElementById('restaurant-name');
            const restaurantType = document.getElementById('restaurant-type');
            const restaurantAvatar = document.getElementById('restaurant-avatar');
            const restaurantCity = document.getElementById('restaurant-city');
            const restaurantPhone = document.getElementById('restaurant-phone');
            const restaurantSince = document.getElementById('restaurant-since');

            if (restaurantName) {
                restaurantName.textContent = currentRestaurant.nombre || 'Mi Restaurante';
            }
            
            if (restaurantType) {
                restaurantType.textContent = currentRestaurant.tipo || 'restaurante';
            }
            
            if (restaurantAvatar) {
                const initials = currentRestaurant.nombre ? 
                    currentRestaurant.nombre.substring(0, 2).toUpperCase() : 'MR';
                restaurantAvatar.textContent = initials;
            }

            if (restaurantCity && currentRestaurant.direccion) {
                restaurantCity.textContent = currentRestaurant.direccion.ciudad || '-';
            }

            if (restaurantPhone) {
                restaurantPhone.textContent = currentRestaurant.telefono || '-';
            }

            if (restaurantSince && currentRestaurant.fechaCreacion) {
                const date = new Date(currentRestaurant.fechaCreacion);
                restaurantSince.textContent = date.toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'short' 
                });
            }

            // Estad√≠sticas del men√∫
            const menu = currentRestaurant.menu || [];
            let totalCategories = menu.length;
            let totalItems = 0;
            let totalPrice = 0;
            let itemCount = 0;

            menu.forEach(category => {
                if (category.items && Array.isArray(category.items)) {
                    totalItems += category.items.length;
                    category.items.forEach(item => {
                        if (item.precio && typeof item.precio === 'number') {
                            totalPrice += item.precio;
                            itemCount++;
                        }
                    });
                }
            });

            const averagePrice = itemCount > 0 ? totalPrice / itemCount : 0;

            // Actualizar tarjetas de estad√≠sticas
            document.getElementById('total-categories').textContent = totalCategories;
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('average-price').textContent = `$${averagePrice.toFixed(0)}`;

            // Calcular completitud del perfil
            const profileCompletion = calculateProfileCompletion();
            document.getElementById('profile-completion').textContent = `${profileCompletion}%`;
            
            const completionStatus = document.getElementById('completion-status');
            if (profileCompletion >= 80) {
                completionStatus.innerHTML = '<i class="fas fa-check"></i><span>Excelente</span>';
                completionStatus.className = 'stat-change positive';
            } else if (profileCompletion >= 50) {
                completionStatus.innerHTML = '<i class="fas fa-exclamation"></i><span>Mejorable</span>';
                completionStatus.className = 'stat-change';
            } else {
                completionStatus.innerHTML = '<i class="fas fa-times"></i><span>Incompleto</span>';
                completionStatus.className = 'stat-change negative';
            }

            // Calcular d√≠as abierto
            const daysOpen = calculateOpenDays();
            document.getElementById('days-open').textContent = `${daysOpen}/7`;

            // An√°lisis del men√∫
            updateMenuAnalysis();
        }

        // Calcular completitud del perfil
        function calculateProfileCompletion() {
            if (!currentRestaurant) return 0;

            let completed = 0;
            let total = 10;

            // Campos b√°sicos (4 puntos)
            if (currentRestaurant.nombre) completed++;
            if (currentRestaurant.descripcion) completed++;
            if (currentRestaurant.telefono) completed++;
            if (currentRestaurant.email) completed++;

            // Direcci√≥n (2 puntos)
            if (currentRestaurant.direccion?.calle) completed++;
            if (currentRestaurant.direccion?.ciudad) completed++;

            // Horarios (1 punto)
            if (currentRestaurant.horarios && Object.keys(currentRestaurant.horarios).length > 0) completed++;

            // Men√∫ (2 puntos)
            if (currentRestaurant.menu && currentRestaurant.menu.length > 0) completed++;
            if (currentRestaurant.menu && currentRestaurant.menu.some(cat => cat.items && cat.items.length > 0)) completed++;

            // Redes sociales (1 punto)
            if (currentRestaurant.redes && Object.values(currentRestaurant.redes).some(red => red)) completed++;

            return Math.round((completed / total) * 100);
        }

        // Calcular d√≠as abierto
        function calculateOpenDays() {
            if (!currentRestaurant?.horarios) return 0;

            const horarios = currentRestaurant.horarios;
            let daysOpen = 0;

            Object.keys(horarios).forEach(day => {
                if (horarios[day]?.apertura && horarios[day]?.cierre) {
                    daysOpen++;
                }
            });

            return daysOpen;
        }

        // Actualizar an√°lisis del men√∫
        function updateMenuAnalysis() {
            const container = document.getElementById('menu-analysis');
            if (!container || !currentRestaurant?.menu) return;

            container.innerHTML = '';

            currentRestaurant.menu.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';

                const items = category.items || [];
                const totalItems = items.length;
                const prices = items.map(item => item.precio).filter(price => typeof price === 'number');
                const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
                const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
                const maxPrice = prices.length > 0 ? Math.max(...prices) : 0;

                categoryDiv.innerHTML = `
                    <div class="category-header">
                        <h4 class="category-name">${category.categoria}</h4>
                    </div>
                    <div class="category-stats">
                        <span><i class="fas fa-utensils"></i> ${totalItems} productos</span>
                        <span><i class="fas fa-dollar-sign"></i> Promedio: $${avgPrice.toFixed(0)}</span>
                        <span><i class="fas fa-arrow-down"></i> Min: $${minPrice}</span>
                        <span><i class="fas fa-arrow-up"></i> Max: $${maxPrice}</span>
                    </div>
                `;

                container.appendChild(categoryDiv);
            });
        }

        // Crear gr√°ficos
        function createCharts() {
            if (!currentRestaurant?.menu) return;

            createPricesChart();
            createCategoryChart();
        }

        // Gr√°fico de precios por categor√≠a
        function createPricesChart() {
            const ctx = document.getElementById('pricesChart');
            if (!ctx) return;

            const menu = currentRestaurant.menu || [];
            const categories = [];
            const avgPrices = [];
            const minPrices = [];
            const maxPrices = [];

            menu.forEach(category => {
                const items = category.items || [];
                const prices = items.map(item => item.precio).filter(price => typeof price === 'number');
                
                if (prices.length > 0) {
                    categories.push(category.categoria);
                    avgPrices.push(Math.round(prices.reduce((a, b) => a + b, 0) / prices.length));
                    minPrices.push(Math.min(...prices));
                    maxPrices.push(Math.max(...prices));
                }
            });

            if (charts.pricesChart) {
                charts.pricesChart.destroy();
            }

            charts.pricesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Precio Promedio',
                        data: avgPrices,
                        backgroundColor: 'rgba(37, 99, 235, 0.8)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Precio M√≠nimo',
                        data: minPrices,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Precio M√°ximo',
                        data: maxPrices,
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de productos por categor√≠a
        function createCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            const menu = currentRestaurant.menu || [];
            const categories = [];
            const itemCounts = [];
            const colors = [
                '#2563eb', '#16a34a', '#dc2626', '#ca8a04', '#9333ea',
                '#c2410c', '#0891b2', '#be123c', '#4338ca', '#059669'
            ];

            menu.forEach((category, index) => {
                const itemCount = category.items ? category.items.length : 0;
                if (itemCount > 0) {
                    categories.push(category.categoria);
                    itemCounts.push(itemCount);
                }
            });

            if (charts.categoryChart) {
                charts.categoryChart.destroy();
            }

            charts.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: itemCounts,
                        backgroundColor: colors.slice(0, categories.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Refrescar estad√≠sticas
        async function refreshStats() {
            showNotification('Actualizando estad√≠sticas...', 'info');
            
            // Destruir gr√°ficos existentes
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};

            await loadRestaurantStats();
            showNotification('Estad√≠sticas actualizadas correctamente', 'success');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                await loadRestaurantStats();
            }
        });
    </script>
</body>
</html>